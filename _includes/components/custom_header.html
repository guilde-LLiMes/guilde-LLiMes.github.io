{% assign github_aux_url = site.aux_links.GitHub | first %}
{% assign github_repo_url = site.github.repository_url | default: github_aux_url %}
{% assign github_repo_nwo = site.github.repository_nwo | default: github_repo_url | replace: "https://github.com/", "" %}
{% assign github_web_base = site.source_links.github_web_base | default: "https://github.com" %}
{% assign github_raw_base_url = site.source_links.github_raw_base | default: "https://raw.githubusercontent.com" %}
{% assign github_branch = site.source_links.branch | default: site.github.source.branch | default: "main" %}
{% assign github_raw_base = github_raw_base_url | append: "/" | append: github_repo_nwo | append: "/refs/heads/" | append: github_branch | append: "/" %}
{% assign github_blob_base = github_web_base | append: "/" | append: github_repo_nwo | append: "/blob/" | append: github_branch | append: "/" %}

<div id="theme-switcher-root" class="theme-switcher">
  <button id="theme-cycle-button" type="button" aria-live="polite" aria-label="Cycle theme">ðŸ–¥ System</button>
  <div class="theme-switcher-version" aria-label="Documentation version">v{{ site.docs_version | default: "0.1.0" }}</div>
</div>

<div
  id="markdown-actions-root"
  class="markdown-actions"
  data-page-path="{{ page.path | escape }}"
  data-raw-base="{{ github_raw_base | escape }}"
  data-blob-base="{{ github_blob_base | escape }}"
  hidden
>
  <div class="markdown-actions-group">
    <button id="markdown-copy-button" type="button" class="markdown-actions-main" aria-describedby="markdown-action-status">
      Markdown
    </button>
    <button
      id="markdown-menu-button"
      type="button"
      class="markdown-actions-toggle"
      aria-haspopup="menu"
      aria-expanded="false"
      aria-controls="markdown-menu"
      aria-label="Open markdown actions"
    >
      â–¾
    </button>
  </div>
  <ul id="markdown-menu" class="markdown-menu" role="menu" hidden>
    <li role="none"><button id="markdown-menu-copy" type="button" role="menuitem">Copy Markdown</button></li>
    <li role="none"><button id="markdown-menu-raw" type="button" role="menuitem">Open Raw Markdown</button></li>
    <li role="none"><button id="markdown-menu-github" type="button" role="menuitem">Open on GitHub</button></li>
  </ul>
  <div id="markdown-action-status" class="markdown-action-status" aria-live="polite"></div>
  <script id="markdown-source-json" type="application/json">{{ page.content | jsonify }}</script>
</div>

<style>
  :root {
    --accent-color: #a2bf58;
    --accent-color-strong: #8fab45;
    --accent-color-soft: #c9dc98;
    --link-color: var(--accent-color);
    --btn-primary-color: var(--accent-color);
  }

  a:not(.nav-list-link):not(.site-title):not(.search-result) {
    color: var(--accent-color);
    font-weight: 700;
  }

  a:not(.nav-list-link):not(.site-title):not(.search-result):hover {
    color: var(--accent-color-strong);
  }

  .site-button {
    color: var(--accent-color);
    border-color: var(--accent-color);
    font-weight: 700;
  }

  .site-button:hover {
    color: #2f3b1a;
    background: var(--accent-color-soft);
    border-color: var(--accent-color);
  }

  .aux-nav .aux-nav-list {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .aux-nav .aux-nav-list-item {
    margin: 0;
  }

  .theme-switcher {
    display: inline-flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.2rem;
  }

  .theme-switcher button {
    font-size: 0.75rem;
    font-weight: 700;
    padding: 0.22rem 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 999px;
    background: transparent;
    color: var(--body-text-color);
    cursor: pointer;
    line-height: 1.2;
  }

  .theme-switcher button:hover {
    border-color: var(--link-color);
    color: var(--link-color);
    background: var(--accent-color-soft);
  }

  .theme-switcher-version {
    font-size: 0.66rem;
    font-weight: 700;
    letter-spacing: 0.02em;
    line-height: 1;
    color: var(--body-text-color);
    opacity: 0.75;
  }

  .site-title {
    font-family: "Courier New", Courier, "Nimbus Mono L", "Liberation Mono", monospace;
    letter-spacing: 0.01em;
    font-weight: 700;
  }

  .site-title .logo-accent {
    color: var(--accent-color);
    font-weight: 700;
  }

  .home-brand-title .logo-accent {
    color: var(--accent-color);
    font-weight: 700;
  }

  .home-brand-title {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    font-family: "Courier New", Courier, "Nimbus Mono L", "Liberation Mono", monospace;
    letter-spacing: 0.01em;
    font-weight: 700;
  }

  .home-brand-logos {
    display: inline-flex;
    align-items: center;
  }

  .site-title .home-brand-logos {
    padding-right: 0.2rem;
  }

  .theme-logo {
    display: none;
    width: 1.1em;
    height: 1.1em;
    object-fit: contain;
    vertical-align: -0.08em;
  }

  .theme-logo.is-active {
    display: inline-block;
  }

  .markdown-actions {
    display: inline-flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.2rem;
    position: relative;
    z-index: 80;
  }

  .breadcrumb-nav.has-markdown-actions {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 0.75rem;
    margin-bottom: 0.35rem;
    position: relative;
    z-index: 5;
  }

  .breadcrumb-nav.has-markdown-actions .breadcrumb-nav-list {
    flex: 1 1 auto;
    min-width: 0;
    margin-bottom: 0.75rem;
    padding-right: 0.5rem;
  }

  .breadcrumb-nav.has-markdown-actions .markdown-actions {
    flex: 0 0 auto;
    margin-left: auto;
    z-index: 30;
  }

  .markdown-actions-row {
    display: flex;
    justify-content: flex-end;
    margin: 0 0 0.85rem 0;
    position: relative;
    z-index: 10;
  }

  .markdown-actions-group {
    display: inline-flex;
    align-items: center;
  }

  .markdown-actions button {
    font-size: 0.75rem;
    font-weight: 700;
    border: 1px solid var(--border-color);
    background: transparent;
    color: var(--body-text-color);
    cursor: pointer;
    line-height: 1.2;
  }

  .markdown-actions-main {
    padding: 0.22rem 0.5rem;
    border-radius: 999px 0 0 999px;
    border-right: none;
  }

  .markdown-actions-toggle {
    padding: 0.22rem 0.4rem;
    border-radius: 0 999px 999px 0;
  }

  .markdown-actions button:hover,
  .markdown-actions button:focus-visible {
    border-color: var(--link-color);
    color: var(--link-color);
    background: var(--accent-color-soft);
    outline: none;
  }

  .markdown-menu {
    position: absolute;
    top: calc(100% + 0.2rem);
    right: 0;
    margin: 0;
    padding: 0.2rem;
    list-style: none;
    min-width: 10rem;
    border: 1px solid var(--border-color);
    border-radius: 0.45rem;
    background: var(--body-background-color);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.16);
    z-index: 60;
  }

  .markdown-menu button {
    width: 100%;
    text-align: left;
    border: none;
    border-radius: 0.3rem;
    padding: 0.4rem 0.45rem;
    color: var(--body-text-color);
  }

  .markdown-action-status {
    position: absolute;
    right: 0;
    bottom: calc(100% + 0.2rem);
    font-size: 0.66rem;
    font-weight: 700;
    letter-spacing: 0.02em;
    line-height: 1;
    white-space: nowrap;
    padding: 0.2rem 0.35rem;
    border-radius: 0.3rem;
    background: var(--body-background-color);
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    color: var(--body-text-color);
    opacity: 0;
    pointer-events: none;
    transform: translateY(0.12rem);
    transition: opacity 120ms ease, transform 120ms ease;
    z-index: 70;
  }

  .markdown-action-status.is-visible {
    opacity: 0.95;
    transform: translateY(0);
  }

  .markdown-action-status.is-error {
    color: #b3261e;
    opacity: 1;
  }

  @media (max-width: 31.24rem) {
    .breadcrumb-nav.has-markdown-actions {
      flex-direction: column;
      align-items: stretch;
    }

    .breadcrumb-nav.has-markdown-actions .markdown-actions {
      align-items: flex-start;
    }

    .markdown-actions-row {
      justify-content: flex-start;
    }
  }
</style>

<script>
  (() => {
    const KEY = "theme-preference";
    const themes = ["system", "light", "dark"];
    const icons = { system: "ðŸ–¥", light: "â˜€", dark: "ðŸŒ™" };
    const media = window.matchMedia("(prefers-color-scheme: dark)");

    const resolveTheme = (preference) => {
      if (preference === "system") return media.matches ? "dark" : "light";
      return preference === "dark" ? "dark" : "light";
    };

    const nextTheme = (preference) => {
      const index = themes.indexOf(preference);
      return themes[(index + 1) % themes.length];
    };

    const formatLabel = (preference) =>
      icons[preference] + " " + preference.charAt(0).toUpperCase() + preference.slice(1);

    const syncThemeLogos = (resolvedTheme) => {
      const lightLogos = document.querySelectorAll(".theme-logo-light");
      const darkLogos = document.querySelectorAll(".theme-logo-dark");
      const useDarkTheme = resolvedTheme === "dark";

      lightLogos.forEach((logo) => logo.classList.toggle("is-active", useDarkTheme));
      darkLogos.forEach((logo) => logo.classList.toggle("is-active", !useDarkTheme));
    };

    const getPreference = () => {
      const stored = localStorage.getItem(KEY);
      return themes.includes(stored) ? stored : "system";
    };

    const styleLogoText = () => {
      const title = document.querySelector(".site-title");
      if (!title) return;
      if (title.dataset.logoStyled === "true") return;

      const original = title.textContent || "";
      const chars = original.split("");
      let lCount = 0;
      let mDone = false;

      const html = chars
        .map((char) => {
          if (char === "L" && lCount < 2) {
            lCount += 1;
            return '<span class="logo-accent">L</span>';
          }
          if (char === "M" && !mDone) {
            mDone = true;
            return '<span class="logo-accent">M</span>';
          }
          return char;
        })
        .join("");

      const logoMarkup =
        '<span class="home-brand-logos" aria-hidden="true">' +
        '<img src="/assets/img/logo-inline-56-light.png" alt="" class="theme-logo theme-logo-light" />' +
        '<img src="/assets/img/logo-inline-56-dark.png" alt="" class="theme-logo theme-logo-dark" />' +
        "</span>";

      title.setAttribute("aria-label", original);
      title.innerHTML = logoMarkup + html;
      title.dataset.logoStyled = "true";
    };

    const applyTheme = (preference) => {
      const resolved = resolveTheme(preference);
      if (window.jtd && typeof window.jtd.setTheme === "function") {
        window.jtd.setTheme(resolved);
      }
      syncThemeLogos(resolved);

      const button = document.getElementById("theme-cycle-button");
      if (button) {
        button.textContent = formatLabel(preference);
        button.setAttribute("aria-label", "Theme mode: " + preference + ". Click to change.");
      }
    };

    const saveAndApply = (preference) => {
      localStorage.setItem(KEY, preference);
      applyTheme(preference);
    };

    const mountInAuxNav = (rootId) => {
      const root = document.getElementById(rootId);
      const auxList = document.querySelector(".aux-nav-list");
      if (root && auxList && !root.closest(".aux-nav")) {
        const item = document.createElement("li");
        item.className = "aux-nav-list-item";
        item.appendChild(root);
        auxList.appendChild(item);
        return true;
      }
      return !!(root && root.closest(".aux-nav"));
    };

    const mountInBreadcrumb = () => {
      const root = document.getElementById("markdown-actions-root");
      if (!root) return false;
      if (root.closest(".breadcrumb-nav")) {
        root.hidden = false;
        return true;
      }

      const breadcrumbNav = document.querySelector(".main-content-wrap .breadcrumb-nav");
      if (breadcrumbNav) {
        breadcrumbNav.classList.add("has-markdown-actions");
        breadcrumbNav.appendChild(root);
        root.hidden = false;
        return true;
      }

      const contentWrap = document.querySelector(".main-content-wrap");
      if (contentWrap) {
        let row = contentWrap.querySelector(".markdown-actions-row");
        if (!row) {
          row = document.createElement("div");
          row.className = "markdown-actions-row";
          contentWrap.prepend(row);
        }
        row.appendChild(root);
        root.hidden = false;
        return true;
      }
      return false;
    };

    const stripFrontMatter = (text) => text.replace(/^---\r?\n[\s\S]*?\r?\n---\r?\n?/, "");

    const copyText = async (text) => {
      if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
        await navigator.clipboard.writeText(text);
        return;
      }

      const fallback = document.createElement("textarea");
      fallback.value = text;
      fallback.setAttribute("readonly", "");
      fallback.style.position = "absolute";
      fallback.style.left = "-9999px";
      document.body.appendChild(fallback);
      fallback.select();
      document.execCommand("copy");
      fallback.remove();
    };

    const initMarkdownActions = () => {
      const root = document.getElementById("markdown-actions-root");
      if (!root) return;

      const copyButton = document.getElementById("markdown-copy-button");
      const toggleButton = document.getElementById("markdown-menu-button");
      const menu = document.getElementById("markdown-menu");
      const menuCopy = document.getElementById("markdown-menu-copy");
      const menuRaw = document.getElementById("markdown-menu-raw");
      const menuGithub = document.getElementById("markdown-menu-github");
      const status = document.getElementById("markdown-action-status");
      const sourceNode = document.getElementById("markdown-source-json");
      if (!copyButton || !toggleButton || !menu || !menuCopy || !menuRaw || !menuGithub || !status) return;

      const menuItems = Array.from(menu.querySelectorAll('button[role="menuitem"]'));
      let markdownCache = null;
      let statusTimer = null;

      const setStatus = (message, isError) => {
        if (statusTimer) {
          window.clearTimeout(statusTimer);
          statusTimer = null;
        }
        status.textContent = message || "";
        status.classList.toggle("is-error", !!isError);
        status.classList.toggle("is-visible", !!message);
        if (message) {
          statusTimer = window.setTimeout(() => {
            status.textContent = "";
            status.classList.remove("is-visible");
            status.classList.remove("is-error");
          }, 2600);
        }
      };

      const buildUrl = (base, pagePath) => {
        if (!base || !pagePath) return "";
        const normalizedPath = pagePath.replace(/^\//, "");
        return base + encodeURI(normalizedPath);
      };

      const getUrls = () => {
        const pagePath = root.dataset.pagePath || "";
        const rawBase = root.dataset.rawBase || "";
        const blobBase = root.dataset.blobBase || "";
        return {
          rawUrl: buildUrl(rawBase, pagePath),
          githubUrl: buildUrl(blobBase, pagePath),
        };
      };

      const closeMenu = (focusToggle) => {
        menu.hidden = true;
        toggleButton.setAttribute("aria-expanded", "false");
        if (focusToggle) toggleButton.focus();
      };

      const openMenu = () => {
        menu.hidden = false;
        toggleButton.setAttribute("aria-expanded", "true");
      };

      const ensureMarkdown = async () => {
        if (markdownCache !== null) return markdownCache;
        if (sourceNode && sourceNode.textContent) {
          try {
            const source = JSON.parse(sourceNode.textContent);
            if (typeof source === "string" && source.length > 0) {
              markdownCache = stripFrontMatter(source);
              return markdownCache;
            }
          } catch (error) {
            // Fall back to remote fetch when local source parsing fails.
          }
        }
        const { rawUrl } = getUrls();
        if (!rawUrl) throw new Error("Unable to resolve markdown URL.");
        const response = await fetch(rawUrl, { credentials: "omit" });
        if (!response.ok) throw new Error("Unable to load markdown source.");
        const source = await response.text();
        markdownCache = stripFrontMatter(source);
        return markdownCache;
      };

      const handleCopy = async () => {
        try {
          const markdown = await ensureMarkdown();
          await copyText(markdown);
          setStatus("Markdown copied.", false);
        } catch (error) {
          setStatus("Unable to load markdown source.", true);
        }
      };

      const openUrl = (url) => {
        if (!url) {
          setStatus("Unable to resolve page source URL.", true);
          return;
        }
        window.open(url, "_blank", "noopener,noreferrer");
        setStatus("", false);
      };

      copyButton.addEventListener("click", handleCopy);
      menuCopy.addEventListener("click", async () => {
        closeMenu(true);
        await handleCopy();
      });
      menuRaw.addEventListener("click", () => {
        closeMenu(true);
        openUrl(getUrls().rawUrl);
      });
      menuGithub.addEventListener("click", () => {
        closeMenu(true);
        openUrl(getUrls().githubUrl);
      });

      toggleButton.addEventListener("click", () => {
        if (menu.hidden) {
          openMenu();
          menuItems[0]?.focus();
          return;
        }
        closeMenu(true);
      });

      toggleButton.addEventListener("keydown", (event) => {
        if (event.key === "ArrowDown") {
          event.preventDefault();
          openMenu();
          menuItems[0]?.focus();
        }
      });

      menu.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          event.preventDefault();
          closeMenu(true);
          return;
        }

        if (event.key !== "ArrowDown" && event.key !== "ArrowUp") return;
        event.preventDefault();
        const currentIndex = menuItems.indexOf(document.activeElement);
        const delta = event.key === "ArrowDown" ? 1 : -1;
        const nextIndex = (currentIndex + delta + menuItems.length) % menuItems.length;
        menuItems[nextIndex]?.focus();
      });

      document.addEventListener("click", (event) => {
        if (!root.contains(event.target)) closeMenu(false);
      });
    };

    const init = () => {
      styleLogoText();
      mountInAuxNav("theme-switcher-root");
      mountInBreadcrumb();
      let preference = getPreference();
      applyTheme(preference);
      initMarkdownActions();

      const button = document.getElementById("theme-cycle-button");
      if (button) {
        button.addEventListener("click", () => {
          preference = nextTheme(preference);
          saveAndApply(preference);
        });
      }
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }

    const onSystemThemeChange = () => {
      const preference = getPreference();
      if (preference === "system") applyTheme("system");
    };

    if (typeof media.addEventListener === "function") {
      media.addEventListener("change", onSystemThemeChange);
    } else if (typeof media.addListener === "function") {
      media.addListener(onSystemThemeChange);
    }
  })();
</script>
