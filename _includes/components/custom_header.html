<div id="theme-switcher-root" class="theme-switcher">
  <button id="theme-cycle-button" type="button" aria-live="polite" aria-label="Cycle theme">Theme: System</button>
</div>

<style>
  .theme-switcher {
    display: flex;
    align-items: center;
  }

  .theme-switcher button {
    font-size: 0.75rem;
    padding: 0.22rem 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 999px;
    background: transparent;
    color: var(--body-text-color);
    cursor: pointer;
    line-height: 1.2;
  }

  .theme-switcher button:hover {
    border-color: var(--link-color);
    color: var(--link-color);
  }
</style>

<script>
  (() => {
    const KEY = "theme-preference";
    const themes = ["system", "light", "dark"];
    const media = window.matchMedia("(prefers-color-scheme: dark)");

    const resolveTheme = (preference) => {
      if (preference === "system") return media.matches ? "dark" : "light";
      return preference === "dark" ? "dark" : "light";
    };

    const nextTheme = (preference) => {
      const index = themes.indexOf(preference);
      return themes[(index + 1) % themes.length];
    };

    const formatLabel = (preference) => {
      return "Theme: " + preference.charAt(0).toUpperCase() + preference.slice(1);
    };

    const getPreference = () => {
      const stored = localStorage.getItem(KEY);
      return themes.includes(stored) ? stored : "system";
    };

    const applyTheme = (preference) => {
      const resolved = resolveTheme(preference);
      if (window.jtd && typeof window.jtd.setTheme === "function") {
        window.jtd.setTheme(resolved);
      }

      const button = document.getElementById("theme-cycle-button");
      if (button) {
        button.textContent = formatLabel(preference);
        button.setAttribute("aria-label", "Theme mode: " + preference + ". Click to change.");
      }
    };

    const saveAndApply = (preference) => {
      localStorage.setItem(KEY, preference);
      applyTheme(preference);
    };

    document.addEventListener("DOMContentLoaded", () => {
      const root = document.getElementById("theme-switcher-root");
      const auxList = document.querySelector(".aux-nav-list");
      const auxNav = document.querySelector(".aux-nav");
      if (root && auxList && !root.closest(".aux-nav")) {
        const item = document.createElement("li");
        item.className = "aux-nav-list-item";
        item.appendChild(root);
        auxList.appendChild(item);
      } else if (root && auxNav && !root.closest(".aux-nav")) {
        auxNav.appendChild(root);
      }

      let preference = getPreference();
      applyTheme(preference);

      const button = document.getElementById("theme-cycle-button");
      if (button) {
        button.addEventListener("click", () => {
          preference = nextTheme(preference);
          saveAndApply(preference);
        });
      }
    });

    media.addEventListener("change", () => {
      const preference = getPreference();
      if (preference === "system") applyTheme("system");
    });
  })();
</script>
