<div id="theme-switcher-root" class="theme-switcher">
  <button id="theme-cycle-button" type="button" aria-live="polite" aria-label="Cycle theme">ðŸ–¥ System</button>
</div>

<style>
  :root {
    --accent-color: #a2bf58;
    --accent-color-strong: #8fab45;
    --accent-color-soft: #c9dc98;
    --link-color: var(--accent-color);
    --btn-primary-color: var(--accent-color);
  }

  a:not(.nav-list-link):not(.site-title):not(.search-result) {
    color: var(--accent-color);
    font-weight: 700;
  }

  a:not(.nav-list-link):not(.site-title):not(.search-result):hover {
    color: var(--accent-color-strong);
  }

  .site-button {
    color: var(--accent-color);
    border-color: var(--accent-color);
    font-weight: 700;
  }

  .site-button:hover {
    color: #2f3b1a;
    background: var(--accent-color-soft);
    border-color: var(--accent-color);
  }

  .aux-nav .aux-nav-list {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .aux-nav .aux-nav-list-item {
    margin: 0;
  }

  .theme-switcher {
    display: flex;
    align-items: center;
  }

  .theme-switcher button {
    font-size: 0.75rem;
    font-weight: 700;
    padding: 0.22rem 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 999px;
    background: transparent;
    color: var(--body-text-color);
    cursor: pointer;
    line-height: 1.2;
  }

  .theme-switcher button:hover {
    border-color: var(--link-color);
    color: var(--link-color);
    background: var(--accent-color-soft);
  }

  .site-title {
    font-family: "Courier New", Courier, "Nimbus Mono L", "Liberation Mono", monospace;
    letter-spacing: 0.01em;
    font-weight: 700;
  }

  .site-title .logo-accent {
    color: var(--accent-color);
    font-weight: 700;
  }

  .home-brand-title .logo-accent {
    color: var(--accent-color);
    font-weight: 700;
  }

  .home-brand-title {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    font-family: "Courier New", Courier, "Nimbus Mono L", "Liberation Mono", monospace;
    letter-spacing: 0.01em;
    font-weight: 700;
  }

  .home-brand-logos {
    display: inline-flex;
    align-items: center;
  }

  .site-title .home-brand-logos {
    padding-right: 0.2rem;
  }

  .theme-logo {
    display: none;
    width: 1.1em;
    height: 1.1em;
    object-fit: contain;
    vertical-align: -0.08em;
  }

  .theme-logo.is-active {
    display: inline-block;
  }
</style>

<script>
  (() => {
    const KEY = "theme-preference";
    const themes = ["system", "light", "dark"];
    const icons = { system: "ðŸ–¥", light: "â˜€", dark: "ðŸŒ™" };
    const media = window.matchMedia("(prefers-color-scheme: dark)");

    const resolveTheme = (preference) => {
      if (preference === "system") return media.matches ? "dark" : "light";
      return preference === "dark" ? "dark" : "light";
    };

    const nextTheme = (preference) => {
      const index = themes.indexOf(preference);
      return themes[(index + 1) % themes.length];
    };

    const formatLabel = (preference) =>
      icons[preference] + " " + preference.charAt(0).toUpperCase() + preference.slice(1);

    const syncThemeLogos = (resolvedTheme) => {
      const lightLogos = document.querySelectorAll(".theme-logo-light");
      const darkLogos = document.querySelectorAll(".theme-logo-dark");
      const useDarkTheme = resolvedTheme === "dark";

      lightLogos.forEach((logo) => logo.classList.toggle("is-active", useDarkTheme));
      darkLogos.forEach((logo) => logo.classList.toggle("is-active", !useDarkTheme));
    };

    const getPreference = () => {
      const stored = localStorage.getItem(KEY);
      return themes.includes(stored) ? stored : "system";
    };

    const styleLogoText = () => {
      const title = document.querySelector(".site-title");
      if (!title) return;
      if (title.dataset.logoStyled === "true") return;

      const original = title.textContent || "";
      const chars = original.split("");
      let lCount = 0;
      let mDone = false;

      const html = chars
        .map((char) => {
          if (char === "L" && lCount < 2) {
            lCount += 1;
            return '<span class="logo-accent">L</span>';
          }
          if (char === "M" && !mDone) {
            mDone = true;
            return '<span class="logo-accent">M</span>';
          }
          return char;
        })
        .join("");

      const logoMarkup =
        '<span class="home-brand-logos" aria-hidden="true">' +
        '<img src="/assets/img/logo-inline-56-light.png" alt="" class="theme-logo theme-logo-light" />' +
        '<img src="/assets/img/logo-inline-56-dark.png" alt="" class="theme-logo theme-logo-dark" />' +
        "</span>";

      title.setAttribute("aria-label", original);
      title.innerHTML = logoMarkup + html;
      title.dataset.logoStyled = "true";
    };

    const applyTheme = (preference) => {
      const resolved = resolveTheme(preference);
      if (window.jtd && typeof window.jtd.setTheme === "function") {
        window.jtd.setTheme(resolved);
      }
      syncThemeLogos(resolved);

      const button = document.getElementById("theme-cycle-button");
      if (button) {
        button.textContent = formatLabel(preference);
        button.setAttribute("aria-label", "Theme mode: " + preference + ". Click to change.");
      }
    };

    const saveAndApply = (preference) => {
      localStorage.setItem(KEY, preference);
      applyTheme(preference);
    };

    const mountInAuxNav = () => {
      const root = document.getElementById("theme-switcher-root");
      const auxList = document.querySelector(".aux-nav-list");
      if (root && auxList && !root.closest(".aux-nav")) {
        const item = document.createElement("li");
        item.className = "aux-nav-list-item";
        item.appendChild(root);
        auxList.appendChild(item);
        return true;
      }
      return !!(root && root.closest(".aux-nav"));
    };

    const init = () => {
      styleLogoText();
      mountInAuxNav();
      let preference = getPreference();
      applyTheme(preference);

      const button = document.getElementById("theme-cycle-button");
      if (button) {
        button.addEventListener("click", () => {
          preference = nextTheme(preference);
          saveAndApply(preference);
        });
      }
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }

    const onSystemThemeChange = () => {
      const preference = getPreference();
      if (preference === "system") applyTheme("system");
    };

    if (typeof media.addEventListener === "function") {
      media.addEventListener("change", onSystemThemeChange);
    } else if (typeof media.addListener === "function") {
      media.addListener(onSystemThemeChange);
    }
  })();
</script>
